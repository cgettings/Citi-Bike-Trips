###########################################################################################-
###########################################################################################-
##
## Creating an updated list of Citi Bike stations ----
##
###########################################################################################-
###########################################################################################-

#-----------------------------------------------------------------------------------------#
# Loading libraries
#-----------------------------------------------------------------------------------------#

library(jsonlite)
library(tidyverse)
library(lubridate)
library(DBI)
library(RSQLite)
library(dbplyr)
library(fs)

#-----------------------------------------------------------------------------------------#
# Specifying directories
#-----------------------------------------------------------------------------------------#

data_dir <- "data/2018"

dir_create(data_dir)

#-----------------------------------------------------------------------------------------#
# Connecting to databases
#-----------------------------------------------------------------------------------------#

citibike_trip_db <- dbConnect(SQLite(), "data/citibike_trip_db.sqlite3")

#-----------------------------------------------------------------------------------------#
# Pulling Stations from trips
#-----------------------------------------------------------------------------------------#

stations_from_trips <- 
    citibike_trip_db %>%
    tbl("citibike_trips") %>%
    arrange(
        start_station_id,
        desc(year),
        desc(month),
        desc(day)
    ) %>% 
    distinct(
        start_station_id,
        start_station_name,
        start_station_latitude,
        start_station_longitude
    ) %>%
    collect() %>% 
    distinct(start_station_id, .keep_all = TRUE) %>% 
    drop_na() %>% 
    rename_all( ~ str_remove(.x, "start_"))


#-----------------------------------------------------------------------------------------#
# Getting stations from GBFS
#-----------------------------------------------------------------------------------------#

stations_from_gbfs <- 
    fromJSON("https://gbfs.citibikenyc.com/gbfs/en/station_information.json")$data$stations %>% 
    as_tibble() %>% 
    select(
        station_id, 
        station_name = name, 
        station_latitude = lat, 
        station_longitude = lon
    ) %>% 
    mutate(station_id = as.integer(station_id))

#-----------------------------------------------------------------------------------------#
# Combining
#-----------------------------------------------------------------------------------------#

stations <- 
    bind_rows(
        stations_from_trips,
        stations_from_gbfs
    ) %>% 
    distinct(station_id, .keep_all = TRUE)

#-----------------------------------------------------------------------------------------#
# Writing RDS
#-----------------------------------------------------------------------------------------#

write_rds(stations, "data/stations.rds")

#-----------------------------------------------------------------------------------------#
# Clearing workspace
#-----------------------------------------------------------------------------------------#

# rm(list = ls())

gc()

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# #
# #                             ---- THIS IS THE END! ----
# #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
