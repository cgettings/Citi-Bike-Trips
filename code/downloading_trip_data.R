##########################################################################################-
##########################################################################################-
##
## Downloading trip data ----
##
##########################################################################################-
##########################################################################################-

# This script downloads Citi Bike trip data from Citi Bike's S3 bucket

#=========================================================================================#
# Setting up ----
#=========================================================================================#

#-----------------------------------------------------------------------------------------#
# Loading libraries
#-----------------------------------------------------------------------------------------#

library(lubridate)
library(tidyverse)
library(fs)
library(glue)
library(here)
 
#-----------------------------------------------------------------------------------------#
# Getting names of existing data files (from raw)
#-----------------------------------------------------------------------------------------#

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# Paths
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

data_paths <- 
    dir_ls(
        glue("{here()}/data/raw"), 
        recurse = FALSE, 
        regexp = ".csv.zip")

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# Just file names
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

data_names <- 
    data_paths %>% 
    path_file() %>% 
    path_ext_remove() %>% 
    path_ext_remove()

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# Parsing names to extract dates
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

data_dates <- 
    data_names %>% 
    str_remove("([:punct:]|[:space:])citibike.*") %>% 
    str_remove("JC([:punct:]|[:space:])") %>% 
    parse_date_time(orders = c("ym"))

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# Putting them all together
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

data_files <- 
    tibble(
        data_names,
        data_paths,
        data_dates
    ) %>%
    arrange(desc(data_dates))

#-----------------------------------------------------------------------------------------#
# Getting names of existing data files (from database)
#-----------------------------------------------------------------------------------------#

# Getting latest date (`slice(1)`), then using that as the first date in a sequence ending 
#   with `today()`

download_dates <- 
    data_files %>% 
    slice(1) %>% 
    pull(data_dates) %>% 
    + months(1) %>%
    seq(from = ., to = now(), by = "1 month") %>%
    as_date()


#=========================================================================================#
# Downloading files ----
#=========================================================================================#

#-----------------------------------------------------------------------------------------#
# Constructing download links ----
#-----------------------------------------------------------------------------------------#

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# Jersey City
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

trip_files_jc <- 
    glue(
        "https://s3.amazonaws.com/tripdata/",
        "JC-{year(download_dates)}{download_dates %>% format('%m')}",
        "-citibike-tripdata.csv.zip"
    )

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# NYC
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

trip_files_nyc <- 
    glue(
        "https://s3.amazonaws.com/tripdata/",
        "{year(download_dates)}{download_dates %>% format('%m')}",
        "-citibike-tripdata.csv.zip"
    )

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# Both together
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

trip_files <- c(trip_files_jc, trip_files_nyc)

#-----------------------------------------------------------------------------------------#
# Downloading ----
#-----------------------------------------------------------------------------------------#

# If method = "libcurl", you can provide a vector for url and destfile and they will
#   download simultaneously

download.file(
    url = trip_files,
    destfile = here(glue("data/raw/{path_file(trip_files)}")),
    mode = "wb",
    method = "libcurl"
)

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# #
# #                             ---- THIS IS THE END! ----
# #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
