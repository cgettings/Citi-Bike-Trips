##########################################################################################-
##########################################################################################-
##
## Downloading trip data ----
##
##########################################################################################-
##########################################################################################-

#=========================================================================================#
# Setting up ----
#=========================================================================================#

#-----------------------------------------------------------------------------------------#
# Loading libraries ----
#-----------------------------------------------------------------------------------------#

library(lubridate)
library(tidyverse)
library(fs)
library(glue)
library(here)

#-----------------------------------------------------------------------------------------#
# Getting names of existing data files ----
#-----------------------------------------------------------------------------------------#

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# Paths
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

data_paths <- 
    dir_ls(
        glue("{here()}/data/raw"), 
        recursive = FALSE, 
        regexp = ".csv.zip")

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# Just file names
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

data_names <- 
    data_paths %>% 
    path_file() %>% 
    path_ext_remove() %>% 
    path_ext_remove()

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# Parsing names to extract dates
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

data_dates <- 
    data_names %>% 
    str_remove("([:punct:]|[:space:])citibike.*") %>% 
    str_remove("JC([:punct:]|[:space:])") %>% 
    parse_date_time(orders = c("ym"))

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# Putting them all together
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

data_files <- 
    tibble(
        data_names,
        data_paths,
        data_dates
    ) %>%
    arrange(desc(data_dates))

#-----------------------------------------------------------------------------------------#
# Getting dates to download
#-----------------------------------------------------------------------------------------#

download_dates <- 
    data_files %>% 
    slice(1) %>% 
    pull(data_dates) %>% 
    + months(1) %>% 
    seq(., now(), "1 month") %>% 
    as_date()

#=========================================================================================#
# Downloading files ----
#=========================================================================================#

#-----------------------------------------------------------------------------------------#
# Constructing download links ----
#-----------------------------------------------------------------------------------------#

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# NYC
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

nyc_files <- 
    glue(
        "https://s3.amazonaws.com/tripdata/",
        "{year(download_dates)}{download_dates %>% format('%m')}",
        "-citibike-tripdata.csv.zip"
    )

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# Jersey City
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

jc_files <- 
    glue(
        "https://s3.amazonaws.com/tripdata/",
        "JC-{year(download_dates)}{download_dates %>% format('%m')}",
        "-citibike-tripdata.csv.zip"
    )

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# Combining
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

nyc_jc_files <- c(nyc_files, jc_files)

#-----------------------------------------------------------------------------------------#
# Downloading ----
#-----------------------------------------------------------------------------------------#

# for (i in 1:length(nyc_jc_files)) {
#     
#     cat("\n", nyc_jc_files[i])
#     
#     tryCatch({
#         
#         download.file(url = nyc_jc_files[i],
#                       destfile = glue("{here()}/data/raw/{path_file(nyc_jc_files[i])}"),
#                       mode = "wb",
#                       method = "libcurl")
#         
#     }, finally = next) 
# }

#-----------------------------------------------------------------------------------------#
# Downloading ----
#-----------------------------------------------------------------------------------------#

# If method = "libcurl", you can provide a vector for url and destfile and they will
#   download simultaneously

download.file(
    url = nyc_jc_files,
    destfile = glue("{here()}/data/raw/{path_file(nyc_jc_files)}"),
    mode = "wb",
    method = "libcurl"
)

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# #
# #                             ---- THIS IS THE END! ----
# #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
